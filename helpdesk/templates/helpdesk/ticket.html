{% extends "helpdesk/base.html" %}
{% load i18n bootstrap4form humanize %}
{% load static %}


{% block helpdesk_title %}{{ ticket.queue.slug }}-{{ ticket.id }} : {% trans "View Ticket Details" %}{% endblock %}

{% block h1_title %}{{ ticket.ticket_for_url }}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
</li>
<li class="breadcrumb-item active">
    {{ ticket.queue.slug }}-{{ ticket.id }}
</li>
{% endblock %}

{% block helpdesk_body %}
{% if helpdesk_settings.HELPDESK_TRANSLATE_TICKET_COMMENTS %}
<div id="google_translate_element"></div>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
{% endif %}

{% include "helpdesk/ticket_desc_table.html" %}

{% if ticket.merged_to %}
<div class="card card-body bg-light">
    <h3 class="text-center">
	{% trans "This ticket has been merged into ticket" %}
	<a href="{{ ticket.merged_to.get_absolute_url }}">{{ ticket.merged_to }}</a>
    </h3>
</div>
{% else %}

{% include "helpdesk/ticket_followup_card.html" %}

<div class="modal fade" id="createChecklistModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Add a new checklist" %}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>{% trans "You can select a template to generate a checklist with a predefined set of tasks." %}</p>
                    <p>{% trans "Ignore it and only give a name to create an empty checklist." %}</p>
                    {{ checklist_form.as_p }}
                </div>
                <div class="modal-footer">
                    <a class="btn btn-secondary" href="{% url 'helpdesk:checklist_templates' %}">
                        {% trans "Manage templates" %}
                    </a>
                    <button type="submit" class="btn btn-primary">{% trans "Add" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}


{% block helpdesk_js %}
<script type='text/javascript' language='javascript'>
    $( function() {
	$( "#id_due_date" ).datepicker({dateFormat: 'yy-mm-dd'});
    } );
</script>

<script type='text/javascript' language='javascript'>
  $(document).ready(function() {
      $("#ShowFurtherEditOptions").click(function() {
          $("#FurtherEditOptions").toggle();
      });

      $("#ShowChecklistEditOptions").click(function() {
          $("#checklistEdit").toggle();
      });

      $('#id_preset').change(function() {
          preset = $('#id_preset').val();
          if (preset != '') {
              $.get("{% url 'helpdesk:raw' 'preset' %}?id=" + preset, function(data) {
                  $("#commentBox").val(data)
              });
          }
      });

      // Preset name of checklist when a template is selected
      $('#id_checklist_template').on('change', function() {
          const nameField = $('#id_name')
          const selectedTemplate = $(this).children(':selected')
          if (nameField.val() === '' && selectedTemplate.val()) {
              nameField.val(selectedTemplate.text())
          }
      })

      $('.disabledTask').on('click', () => {
          alert('{% trans 'If you want to update state of checklist tasks, please do a Follow-Up response and click on "Update checklists"' %}')
      })

      $("[data-toggle=tooltip]").tooltip();

      {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
      $("#ShowFileUpload").click(function() {
          $("#FileUpload").fadeIn();
          $("#ShowFileUploadPara").hide();
      });

      // lists for file input change events, then updates the associated text label
      // with the file name selected
      $('.add_file_fields_wrap').on('fileselect', ':file', function(event, numFiles, label, browseButtonNum) {
          $("#selectedfilename"+browseButtonNum).html(label);
      });

      var x = 0;
      var wrapper         = $(".add_file_fields_wrap"); //Fields wrapper
      var add_button      = $(".add_file_field_button"); //Add button ID

      $(add_button).click(function(e){ //on add input button click
          x++;
          e.preventDefault();
          $(wrapper).append("<div><label class='btn btn-primary btn-sm btn-file'>Browse... <input type='file' name='attachment' id='file" + x + "' multiple style='display: none;'/></label><span>&nbsp;</span><span id='selectedfilename" + x + "'>{% trans 'No files selected.' %}</span></div>"); //add input box
      });
      {% endif %}
  });

  {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
  // this function listens for changes on any file input, and
  // emits the appropriate event to update the input's text.
  // Needed to have properly styled file input buttons! (this really shouldn't be this hard...)
  $(document).on('change', ':file', function() {
      var input = $(this),
          inputWidgetNum = $(this).attr('id').split("file")[1],
          numFiles = input.get(0).files ? input.get(0).files.length : 1,
          label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
      input.trigger('fileselect', [numFiles, label, inputWidgetNum]);
  });
  {% endif %}
  </script>
{% endblock %}


{# Emacs: #}
{# Local Variables: #}
{# sgml-basic-offset: 4 #}
{# End: #}
